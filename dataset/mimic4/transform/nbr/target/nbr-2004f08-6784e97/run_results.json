{"metadata": {"dbt_schema_version": "https://schemas.getdbt.com/dbt/run-results/v6.json", "dbt_version": "1.10.13", "generated_at": "2025-10-23T05:39:58.827869Z", "invocation_id": "66b4f6d2-1323-48d9-a137-70149fd28546", "invocation_started_at": "2025-10-23T05:39:58.395759Z", "env": {}}, "results": [{"status": "success", "timing": [{"name": "compile", "started_at": "2025-10-23T05:39:58.762144Z", "completed_at": "2025-10-23T05:39:58.766094Z"}, {"name": "execute", "started_at": "2025-10-23T05:39:58.766289Z", "completed_at": "2025-10-23T05:39:58.823459Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.062036991119384766, "adapter_response": {"_message": "OK"}, "message": "OK", "failures": null, "unique_id": "model.nbr.stg_labs", "compiled": true, "compiled_code": "\n\n/*\nStaging: Lab Events (\u68c0\u9a8c\u7ed3\u679c) - \u6700\u590d\u6742\u7684\u5904\u7406\n\n\u529f\u80fd:\n1. Top-200 \u8fc7\u6ee4\uff1a\u53ea\u4fdd\u7559\u6700\u5e38\u89c1\u7684 200 \u79cd\u68c0\u9a8c\n2. \"\u635e\u56de\"\u7b56\u7565\uff1a\u627e\u56de\u5165\u9662\u524d 24 \u5c0f\u65f6\u7684\u68c0\u9a8c\n3. \u6570\u503c\u5206\u7bb1\uff1aQ1-Q10 \u5206\u4f4d\u6570\u79bb\u6563\u5316\uff08ETHOS \u65b9\u6cd5\uff09\n\nETHOS \u7b56\u7565:\n- \u8fde\u7eed\u6570\u503c \u2192 \u79bb\u6563\u7c7b\u522b\uff08Q1-Q10\uff09\n- \u4fdd\u7559 NULL \u503c\u4f5c\u4e3a\u5355\u72ec\u7c7b\u522b\n- \u8bcd\u8868: 200 itemid \u00d7 11 \u72b6\u6001 = 2200 \u4e2a lab tokens\n\n\u8f93\u51fa:\n- \u6bcf\u884c = \u4e00\u4e2a\u68c0\u9a8c\u7ed3\u679c\uff08\u5df2\u5206\u7bb1\uff09\n- code \u683c\u5f0f: LAB:itemid_Q5\n- \u5305\u542b\u7cbe\u786e charttime\n*/\n\n-- ============================================================================\n-- Step 1: \u6269\u5c55\u68c0\u9a8c\u6570\u636e\uff08\u539f\u6709 + \u635e\u56de\uff09\n-- ============================================================================\nwith labs_original as (\n    -- 1.1 \u539f\u672c\u6709 hadm_id \u7684\u4f4f\u9662\u68c0\u9a8c\n    select \n        subject_id,\n        hadm_id,\n        itemid,\n        charttime,\n        valuenum\n    from \"mimic4\".\"main\".\"raw_labevents\"\n    where hadm_id is not null\n        and itemid in (select itemid from \"mimic4\".\"main\".\"top_200_labs\")\n),\n\nlabs_reclaimed_raw as (\n    -- 1.2 \"\u635e\u56de\"\u5019\u9009\uff1a\u5165\u9662\u524d 24 \u5c0f\u65f6\u7684\u68c0\u9a8c\n    select \n        l.labevent_id,\n        l.subject_id,\n        a.hadm_id,  -- \u5206\u914d hadm_id\n        l.itemid,\n        l.charttime,\n        l.valuenum,\n        a.admittime,\n        abs(extract(epoch from (l.charttime - a.admittime))) as time_diff_seconds\n    from \"mimic4\".\"main\".\"raw_labevents\" l\n    join \"mimic4\".\"main\".\"stg_admissions\" a \n        on l.subject_id = a.subject_id\n        and l.hadm_id is null  -- \u539f\u672c\u6ca1\u6709 hadm_id\n        and l.charttime >= (a.admittime - interval '24 hours')\n        and l.charttime <= a.admittime\n    where l.itemid in (select itemid from \"mimic4\".\"main\".\"top_200_labs\")\n),\n\nlabs_reclaimed as (\n    -- 1.3 \u6bcf\u4e2a\u68c0\u9a8c\u53ea\u5206\u914d\u7ed9\u6700\u8fd1\u7684\u5c31\u8bca\n    select \n        subject_id,\n        hadm_id,\n        itemid,\n        charttime,\n        valuenum\n    from (\n        select \n            *,\n            row_number() over (partition by labevent_id order by time_diff_seconds) as rn\n        from labs_reclaimed_raw\n    ) ranked\n    where rn = 1\n),\n\nlabs_extended as (\n    -- 1.4 \u5408\u5e76\u539f\u6709\u548c\u635e\u56de\u7684\n    select * from labs_original\n    union all\n    select * from labs_reclaimed\n),\n\n-- ============================================================================\n-- Step 2: \u6570\u503c\u5206\u7bb1\uff08Q1-Q10\uff09\n-- ============================================================================\nlabs_binned as (\n    select \n        l.subject_id,\n        l.hadm_id,\n        l.itemid,\n        l.charttime,\n        l.valuenum,\n        -- \u5206\u7bb1\u903b\u8f91\uff0811\u4e2a\u7c7b\u522b\uff09\n        case \n            when l.valuenum is null then 'LAB:' || l.itemid || '_NULL'\n            when l.valuenum <= q.q1 then 'LAB:' || l.itemid || '_Q1'\n            when l.valuenum <= q.q2 then 'LAB:' || l.itemid || '_Q2'\n            when l.valuenum <= q.q3 then 'LAB:' || l.itemid || '_Q3'\n            when l.valuenum <= q.q4 then 'LAB:' || l.itemid || '_Q4'\n            when l.valuenum <= q.q5 then 'LAB:' || l.itemid || '_Q5'\n            when l.valuenum <= q.q6 then 'LAB:' || l.itemid || '_Q6'\n            when l.valuenum <= q.q7 then 'LAB:' || l.itemid || '_Q7'\n            when l.valuenum <= q.q8 then 'LAB:' || l.itemid || '_Q8'\n            when l.valuenum <= q.q9 then 'LAB:' || l.itemid || '_Q9'\n            else 'LAB:' || l.itemid || '_Q10'\n        end as code\n    from labs_extended l\n    left join \"mimic4\".\"main\".\"lab_quantiles\" q \n        on l.itemid = q.itemid\n)\n\n-- ============================================================================\n-- Step 3: \u6700\u7ec8\u8f93\u51fa\n-- ============================================================================\nselect \n    subject_id,\n    hadm_id,\n    code,\n    'lab' as code_type,\n    charttime as event_time,  -- \u68c0\u9a8c\u65f6\u95f4\uff08\u79d2\u7ea7\u7cbe\u5ea6\uff09\n    row_number() over (\n        partition by subject_id, hadm_id \n        order by charttime\n    ) as seq_num\nfrom labs_binned", "relation_name": "\"mimic4\".\"main\".\"stg_labs\"", "batch_results": null}], "elapsed_time": 0.1451272964477539, "args": {"require_explicit_package_overrides_for_builtin_materializations": true, "indirect_selection": "eager", "defer": false, "log_level": "info", "export_saved_queries": false, "validate_macro_args": false, "partial_parse": true, "write_json": true, "exclude": [], "empty": false, "which": "build", "log_level_file": "debug", "printer_width": 80, "state_modified_compare_vars": false, "use_fast_test_edges": false, "require_nested_cumulative_type_params": false, "upload_to_artifacts_ingest_api": false, "require_yaml_configuration_for_mf_time_spines": false, "select": ["nbr.stg.stg_labs"], "favor_state": false, "populate_cache": true, "state_modified_compare_more_unrendered_values": false, "project_dir": "/Users/gin/Desktop/HAT/ehr-fm/dataset/mimic4/transform/nbr", "exclude_resource_types": [], "require_all_warnings_handled_by_warn_error": false, "strict_mode": false, "resource_types": [], "partial_parse_file_diff": true, "require_generic_test_arguments_property": true, "log_format_file": "json", "use_colors_file": true, "invocation_command": "dbt build --select nbr.stg.stg_labs", "log_file_max_bytes": 10485760, "require_resource_names_without_spaces": true, "static_parser": true, "skip_nodes_if_on_run_start_fails": false, "introspect": true, "require_batched_execution_for_custom_microbatch_strategy": false, "send_anonymous_usage_stats": false, "show_resource_report": false, "use_colors": true, "version_check": true, "quiet": false, "show_all_deprecations": false, "cache_selected_only": false, "log_path": "/Users/gin/Desktop/HAT/ehr-fm/dataset/mimic4/transform/nbr/target/nbr-2004f08-6784e97", "macro_debugging": false, "source_freshness_run_project_hooks": true, "vars": {}, "show": false, "warn_error_options": {"error": [], "warn": [], "silence": []}, "target_path": "target/nbr-2004f08-6784e97", "profiles_dir": "/Users/gin/Desktop/HAT/ehr-fm/dataset/mimic4/transform/nbr", "include_saved_query": false, "print": true, "log_format": "json"}}