{"metadata": {"dbt_schema_version": "https://schemas.getdbt.com/dbt/run-results/v6.json", "dbt_version": "1.10.13", "generated_at": "2025-10-23T05:40:40.882073Z", "invocation_id": "ae785d26-72ac-463e-a1af-55ceb79e7fd1", "invocation_started_at": "2025-10-23T05:40:23.400730Z", "env": {}}, "results": [{"status": "success", "timing": [{"name": "compile", "started_at": "2025-10-23T05:40:23.735069Z", "completed_at": "2025-10-23T05:40:23.738705Z"}, {"name": "execute", "started_at": "2025-10-23T05:40:23.738908Z", "completed_at": "2025-10-23T05:40:40.877542Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 17.143126010894775, "adapter_response": {"_message": "OK"}, "message": "OK", "failures": null, "unique_id": "model.nbr.events_merged", "compiled": true, "compiled_code": "\n\n/*\nCurated: Events Merged (\u4e8b\u4ef6\u5408\u5e76 - ETHOS Pipeline \u6838\u5fc3)\n\n\u529f\u80fd:\n1. \u5408\u5e76 4 \u7c7b\u4e8b\u4ef6\uff08DX + PR + LAB + MED\uff09\n2. \u8ba1\u7b97\u65f6\u95f4\u504f\u79fb\uff08\u8ddd\u5165\u9662\u5c0f\u65f6\u6570\uff09\n3. \u5168\u5c40\u65f6\u95f4\u6392\u5e8f\uff08ETHOS \u5173\u952e\u7279\u6027\uff09\n\nETHOS \u7b56\u7565:\n- \u6240\u6709\u4e8b\u4ef6\u6309\u5b9e\u9645\u53d1\u751f\u65f6\u95f4\u6392\u5e8f\n- \u4e0d\u6309\u7c7b\u578b\u5206\u7ec4\n- \u4fdd\u7559\u65f6\u95f4\u4fe1\u606f\u7528\u4e8e\u540e\u7eed\u63d2\u5165 TIME_BIN\n\n\u8f93\u51fa:\n- \u6bcf\u884c = \u4e00\u4e2a\u4e8b\u4ef6\uff08\u8bca\u65ad/\u624b\u672f/\u68c0\u9a8c/\u7528\u836f\uff09\n- \u6309 subject_id, visit_seq, \u65f6\u95f4 \u6392\u5e8f\n- \u5305\u542b time_offset_hours \u7528\u4e8e TIME_BIN \u751f\u6210\n*/\n\n-- ============================================================================\n-- Step 1: \u5408\u5e76\u6240\u6709\u4e8b\u4ef6\n-- ============================================================================\nwith all_events as (\n    select * from \"mimic4\".\"main\".\"stg_diagnoses\"\n    union all\n    select * from \"mimic4\".\"main\".\"stg_procedures\"\n    union all\n    select * from \"mimic4\".\"main\".\"stg_labs\"\n    union all\n    select * from \"mimic4\".\"main\".\"stg_medications\"\n),\n\n-- ============================================================================\n-- Step 2: \u5173\u8054\u5c31\u8bca\u4fe1\u606f\u5e76\u8ba1\u7b97\u65f6\u95f4\u504f\u79fb\n-- ============================================================================\nevents_with_time as (\n    select \n        a.subject_id,\n        a.hadm_id,\n        a.admittime,\n        a.visit_seq,\n        a.days_since_prior_admission,\n        e.code,\n        e.code_type,\n        e.event_time,\n        \n        -- \u8ba1\u7b97\u65f6\u95f4\u504f\u79fb\uff08\u5c0f\u65f6\uff09\n        -- \u7b56\u7565\uff1a\u8bca\u65ad\u65e0\u65f6\u95f4\uff0c\u653e\u5728\u6700\u524d\u9762\uff08-0.001\u5c0f\u65f6\uff09\n        case \n            when e.event_time is null then -0.001\n            else extract(epoch from (e.event_time - a.admittime)) / 3600.0\n        end as time_offset_hours\n        \n    from \"mimic4\".\"main\".\"stg_admissions\" a\n    join all_events e on a.hadm_id = e.hadm_id\n),\n\n-- ============================================================================\n-- Step 3: \u5168\u5c40\u65f6\u95f4\u6392\u5e8f\u5e76\u91cd\u65b0\u7f16\u53f7\n-- ============================================================================\nevents_sorted as (\n    select \n        *,\n        -- \u5168\u5c40\u5e8f\u53f7\uff08\u6309\u65f6\u95f4\u6392\u5e8f\uff09\n        row_number() over (\n            partition by subject_id, hadm_id \n            order by \n                time_offset_hours,  -- \u9996\u5148\u6309\u65f6\u95f4\n                code                -- \u65f6\u95f4\u76f8\u540c\u65f6\u6309 code \u5b57\u5178\u5e8f\uff08\u786e\u5b9a\u6027\uff09\n        ) as event_seq\n    from events_with_time\n)\n\n-- ============================================================================\n-- \u6700\u7ec8\u8f93\u51fa\n-- ============================================================================\nselect \n    subject_id,\n    hadm_id,\n    admittime,\n    visit_seq,\n    days_since_prior_admission,  -- \u2190 \u4fdd\u7559\u76f8\u5bf9\u65f6\u95f4\uff08\u7528\u4e8e Dataset cumsum\uff09\n    code,\n    code_type,\n    event_time,\n    time_offset_hours,\n    event_seq\nfrom events_sorted\norder by \n    subject_id, \n    visit_seq, \n    event_seq  -- \u2190 ETHOS \u5173\u952e\uff1a\u5168\u5c40\u65f6\u95f4\u6392\u5e8f", "relation_name": "\"mimic4\".\"main\".\"events_merged\"", "batch_results": null}], "elapsed_time": 17.202590227127075, "args": {"require_generic_test_arguments_property": true, "log_path": "/Users/gin/Desktop/HAT/ehr-fm/dataset/mimic4/transform/nbr/target/nbr-2c5dbc5-ecc96fb", "profiles_dir": "/Users/gin/Desktop/HAT/ehr-fm/dataset/mimic4/transform/nbr", "require_resource_names_without_spaces": true, "use_colors": true, "populate_cache": true, "invocation_command": "dbt build --select nbr.curated.events_merged", "introspect": true, "printer_width": 80, "use_fast_test_edges": false, "require_yaml_configuration_for_mf_time_spines": false, "which": "build", "log_format": "json", "vars": {}, "quiet": false, "require_batched_execution_for_custom_microbatch_strategy": false, "cache_selected_only": false, "require_explicit_package_overrides_for_builtin_materializations": true, "defer": false, "select": ["nbr.curated.events_merged"], "log_level": "info", "validate_macro_args": false, "write_json": true, "show": false, "state_modified_compare_vars": false, "log_file_max_bytes": 10485760, "macro_debugging": false, "strict_mode": false, "exclude": [], "include_saved_query": false, "log_level_file": "debug", "log_format_file": "json", "require_nested_cumulative_type_params": false, "resource_types": [], "source_freshness_run_project_hooks": true, "project_dir": "/Users/gin/Desktop/HAT/ehr-fm/dataset/mimic4/transform/nbr", "partial_parse_file_diff": true, "skip_nodes_if_on_run_start_fails": false, "target_path": "target/nbr-2c5dbc5-ecc96fb", "partial_parse": true, "require_all_warnings_handled_by_warn_error": false, "upload_to_artifacts_ingest_api": false, "use_colors_file": true, "version_check": true, "warn_error_options": {"error": [], "warn": [], "silence": []}, "favor_state": false, "export_saved_queries": false, "print": true, "empty": false, "indirect_selection": "eager", "static_parser": true, "state_modified_compare_more_unrendered_values": false, "show_resource_report": false, "exclude_resource_types": [], "send_anonymous_usage_stats": false, "show_all_deprecations": false}}